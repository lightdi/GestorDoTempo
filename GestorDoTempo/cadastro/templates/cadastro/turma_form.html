{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">{{ view.action }} Turma</h2>
                <div>
                    <a href="{% url 'turma_list' %}" class="btn btn-light me-2">Cancelar</a>
                    <button type="submit" form="main-form" class="btn btn-light fw-bold">Salvar</button>
                </div>
            </div>
            <div class="card-body">
                <form method="post" id="main-form">
                    {% csrf_token %}

                    <!-- Campos básicos -->
                    <div class="mb-3">
                        <label for="{{ form.nome.id_for_label }}" class="form-label">Nome</label>
                        {{ form.nome }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.curso.id_for_label }}" class="form-label">Curso</label>
                        {{ form.curso }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.periodo.id_for_label }}" class="form-label">Período</label>
                        {{ form.periodo }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.abreviatura.id_for_label }}" class="form-label">Abreviatura</label>
                        {{ form.abreviatura }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.cor.id_for_label }}" class="form-label">Cor</label>
                        {{ form.cor }}
                    </div>

                    <!-- Aulas (Search and Add) -->
                    <div class="mb-3 mt-4">
                        <label class="form-label">Aulas</label>

                        <!-- Hidden original select -->
                        <div class="d-none">
                            {{ form.aulas }}
                        </div>

                        <!-- Search Interface -->
                        <div class="input-group mb-2">
                            <input type="text" id="search-aula" class="form-control"
                                placeholder="Pesquisar aula (Disciplina - Professor)...">
                            <button class="btn btn-outline-secondary" type="button" id="clear-search">Limpar</button>
                        </div>

                        <!-- Search Results -->
                        <div id="aula-results" class="list-group mb-3"
                            style="max-height: 200px; overflow-y: auto; display: none;">
                            <!-- Results will be injected here via JS -->
                        </div>

                        <!-- Selected Aulas List -->
                        <div class="card mb-3">
                            <div class="card-header bg-light text-dark">
                                <strong>Aulas Selecionadas</strong>
                            </div>
                            <ul id="selected-aulas-list" class="list-group list-group-flush">
                                <!-- Selected items will be injected here via JS -->
                            </ul>
                        </div>

                        <!-- Create/Edit Aula Inline -->
                        <div class="card">
                            <div
                                class="card-header bg-light d-flex justify-content-between align-items-center text-dark">
                                <strong id="aula-form-title">Nova Aula Rápida</strong>
                                <button type="button" id="btn-cancel-edit" class="btn btn-sm btn-outline-secondary"
                                    style="display: none;">Cancelar Edição</button>
                            </div>
                            <div class="card-body">
                                <input type="hidden" id="editing-aula-id">

                                <!-- Filtro de Curso para Disciplinas -->
                                <div class="mb-2">
                                    <label for="filter-curso" class="form-label small text-muted">Filtrar Disciplinas
                                        por Curso:</label>
                                    <select id="filter-curso" class="form-select form-select-sm">
                                        <option value="todos">Todos os Cursos</option>
                                        <option value="geral">Geral (Sem Curso)</option>
                                        {% for c in cursos %}
                                        <option value="{{ c.id }}">{{ c.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <select id="new-aula-disciplina" class="form-select">
                                            <option value="">Selecione a Disciplina</option>
                                            {% for d in disciplinas %}
                                            <option value="{{ d.id }}" data-curso-id="{{ d.curso.id|default:'geral' }}">
                                                {{ d.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="new-aula-professor" class="form-select">
                                            <option value="">Selecione o Professor</option>
                                            {% for p in professores %}
                                            <option value="{{ p.id }}">{{ p.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="new-aula-sala" class="form-select">
                                            <option value="">Selecione a Sala</option>
                                            {% for s in salas %}
                                            <option value="{{ s.id }}">{{ s.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" id="btn-save-aula"
                                            class="btn btn-success w-100">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Dias/Tempos Permitidos -->
                    <h4 class="mt-4 mb-3">Dias e Tempos Permitidos</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead>
                                <tr>
                                    <th>Tempo / Dia</th>
                                    {% for dia in dias_semana %}
                                    <th>
                                        {{ dia.nome }}
                                        <br>
                                        <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1"
                                            onclick="toggleColumn('{{ dia.id }}')">
                                            <small>⬇️</small>
                                        </button>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in grid_rows %}
                                <tr>
                                    <td class="fw-bold">
                                        {{ row.tempo.nome }} <br> <small>{{ row.tempo.inicio }} - {{ row.tempo.fim
                                            }}</small>
                                        <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1 ms-2"
                                            onclick="toggleRow(this)">
                                            <small>➡️</small>
                                        </button>
                                    </td>
                                    {% for slot in row.slots %}
                                    <td>
                                        {% if slot.slot_id %}
                                        <input type="checkbox" name="dias" value="{{ slot.slot_id }}"
                                            class="form-check-input col-dia-{{ slot.dia.id }}" {% if slot.is_checked %}
                                            checked {% endif %}>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Aula Search and Add Logic
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-aula');
        const resultsContainer = document.getElementById('aula-results');
        const selectedList = document.getElementById('selected-aulas-list');
        const originalSelect = document.getElementById('{{ form.aulas.id_for_label }}');
        const clearBtn = document.getElementById('clear-search');

        // New/Edit Aula Elements
        const btnSaveAula = document.getElementById('btn-save-aula');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');
        const newDisciplina = document.getElementById('new-aula-disciplina');
        const newProfessor = document.getElementById('new-aula-professor');
        const newSala = document.getElementById('new-aula-sala');
        const editingIdInput = document.getElementById('editing-aula-id');
        const formTitle = document.getElementById('aula-form-title');

        // Filter Elements
        const filterCurso = document.getElementById('filter-curso');
        // Store original options for filtering
        const originalDisciplinaOptions = Array.from(newDisciplina.options);

        // Filter Logic
        filterCurso.addEventListener('change', function () {
            const selectedCurso = this.value;
            const currentSelectedDisciplina = newDisciplina.value;

            // Clear current options
            newDisciplina.innerHTML = '';

            originalDisciplinaOptions.forEach(opt => {
                // Always include the placeholder
                if (opt.value === "") {
                    newDisciplina.appendChild(opt);
                    return;
                }

                const cursoId = opt.getAttribute('data-curso-id');
                let show = false;

                if (selectedCurso === 'todos') {
                    show = true;
                } else if (selectedCurso === 'geral') {
                    if (cursoId === 'geral' || !cursoId) show = true;
                } else {
                    if (cursoId === selectedCurso) show = true;
                }

                if (show) {
                    newDisciplina.appendChild(opt);
                }
            });

            // Try to preserve selection if visible, otherwise select placeholder
            if (Array.from(newDisciplina.options).some(opt => opt.value === currentSelectedDisciplina)) {
                newDisciplina.value = currentSelectedDisciplina;
            } else {
                newDisciplina.value = "";
            }
        });

        // Parse available options from the hidden select
        const availableOptions = Array.from(originalSelect.options).map(opt => ({
            value: opt.value,
            text: opt.text,
            selected: opt.selected
        }));

        function renderSelected() {
            selectedList.innerHTML = '';
            const selectedOptions = Array.from(originalSelect.options).filter(opt => opt.selected);

            if (selectedOptions.length === 0) {
                selectedList.innerHTML = '<li class="list-group-item text-muted">Nenhuma aula selecionada.</li>';
                return;
            }

            selectedOptions.forEach(opt => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span>${opt.text}</span>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary me-2 edit-aula" data-value="${opt.value}">Editar</button>
                        <button type="button" class="btn btn-sm btn-danger remove-aula" data-value="${opt.value}">Remover</button>
                    </div>
                `;
                selectedList.appendChild(li);
            });

            // Attach event listeners
            document.querySelectorAll('.remove-aula').forEach(btn => {
                btn.addEventListener('click', function () {
                    const value = this.getAttribute('data-value');
                    const option = Array.from(originalSelect.options).find(opt => opt.value === value);
                    if (option) {
                        option.selected = false;
                        renderSelected();
                        if (searchInput.value.trim() !== '') {
                            filterResults(searchInput.value);
                        }
                    }
                });
            });

            document.querySelectorAll('.edit-aula').forEach(btn => {
                btn.addEventListener('click', function () {
                    const id = this.getAttribute('data-value');
                    startEditing(id);
                });
            });
        }

        function startEditing(id) {
            // Reset form first
            resetForm();

            // Fetch details
            fetch(`/cadastro/ajax/get-aula-details/${id}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Erro ao carregar aula: ' + data.error);
                        return;
                    }

                    // Populate form
                    editingIdInput.value = data.id;

                    // Note: If the discipline is hidden by the current filter, we should probably reset the filter or show it temporarily.
                    // For simplicity, let's reset filter to 'todos' to ensure the option exists
                    filterCurso.value = 'todos';
                    filterCurso.dispatchEvent(new Event('change'));

                    newDisciplina.value = data.disciplina_id;
                    newProfessor.value = data.professor_id;
                    newSala.value = data.sala_id;

                    // Update UI state
                    formTitle.textContent = 'Editar Aula';
                    btnSaveAula.textContent = 'Salvar';
                    btnSaveAula.classList.remove('btn-success');
                    btnSaveAula.classList.add('btn-primary');
                    btnCancelEdit.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }

        function resetForm() {
            editingIdInput.value = '';
            newDisciplina.value = '';
            newProfessor.value = '';
            newSala.value = '';

            formTitle.textContent = 'Nova Aula Rápida';
            btnSaveAula.textContent = '+';
            btnSaveAula.classList.remove('btn-primary');
            btnSaveAula.classList.add('btn-success');
            btnCancelEdit.style.display = 'none';
        }

        btnCancelEdit.addEventListener('click', resetForm);

        function filterResults(query) {
            resultsContainer.innerHTML = '';
            if (!query) {
                resultsContainer.style.display = 'none';
                return;
            }

            const lowerQuery = query.toLowerCase();
            const matches = Array.from(originalSelect.options).filter(opt =>
                !opt.selected && opt.text.toLowerCase().includes(lowerQuery)
            );

            if (matches.length === 0) {
                resultsContainer.innerHTML = '<div class="list-group-item text-muted">Nenhuma aula encontrada.</div>';
            } else {
                matches.forEach(opt => {
                    const a = document.createElement('a');
                    a.href = '#';
                    a.className = 'list-group-item list-group-item-action';
                    a.textContent = opt.text;
                    a.addEventListener('click', function (e) {
                        e.preventDefault();
                        opt.selected = true;
                        searchInput.value = ''; // Clear search after selection
                        resultsContainer.style.display = 'none';
                        renderSelected();
                    });
                    resultsContainer.appendChild(a);
                });
            }
            resultsContainer.style.display = 'block';
        }

        searchInput.addEventListener('input', function () {
            filterResults(this.value);
        });

        clearBtn.addEventListener('click', function () {
            searchInput.value = '';
            resultsContainer.style.display = 'none';
        });

        // Create/Update Aula AJAX
        btnSaveAula.addEventListener('click', function () {
            const disciplinaId = newDisciplina.value;
            const professorId = newProfessor.value;
            const salaId = newSala.value;
            const editingId = editingIdInput.value;

            if (!disciplinaId || !professorId || !salaId) {
                alert('Por favor, selecione Disciplina, Professor e Sala.');
                return;
            }

            const formData = new FormData();
            formData.append('disciplina', disciplinaId);
            formData.append('professor', professorId);
            formData.append('sala', salaId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            let url = '{% url "create_aula_ajax" %}';
            if (editingId) {
                url = '{% url "update_aula_ajax" %}';
                formData.append('id', editingId);
            }

            fetch(url, {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Erro: ' + data.error);
                    } else {
                        if (editingId) {
                            // Update existing option text
                            const option = Array.from(originalSelect.options).find(opt => opt.value === editingId);
                            if (option) {
                                option.text = data.text;
                            }
                        } else {
                            // Create new option
                            const newOption = new Option(data.text, data.id, true, true);
                            originalSelect.add(newOption);
                        }

                        // Update UI
                        renderSelected();
                        resetForm();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao salvar aula.');
                });
        });

        // Initial render
        renderSelected();
    });

    function toggleColumn(diaId) {
        const checkboxes = document.querySelectorAll('.col-dia-' + diaId);
        // Check if all are checked to decide whether to uncheck or check all
        let allChecked = true;
        checkboxes.forEach(cb => {
            if (!cb.checked) allChecked = false;
        });

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
    }

    function toggleRow(btn) {
        const row = btn.closest('tr');
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');

        let allChecked = true;
        checkboxes.forEach(cb => {
            if (!cb.checked) allChecked = false;
        });

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
    }
</script>
{% endblock %}